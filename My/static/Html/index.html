<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=0, maximum-scale=2.0, user-scalable=yes"
    />
    <title>YHH</title>
    <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
    <script src="../JS/axios.min.js"></script>
    <link rel="stylesheet" href="../css/index.css" />
    <link rel="icon" type="image/x-icon" href="../IMG/Rabbit_Grey.png" />
  </head>

  <body>
    <div id="Title_Box">
      <div id="Title_Logo">
        <img
          src="../IMG/Rabbit_Logo.png"
          onclick="Exit()"
          style="cursor: pointer"
        />
      </div>
      <div id="Title_Font">
        <div id="Title_Font_Logo">
          <img
            src="../IMG/Question.png"
            title="创建 RaBBit ID"
            onclick="Register_Page(true)"
          />
        </div>
        <div id="Title_Font_Box"></div>
      </div>
    </div>
    <div id="Prompt_Box">
      <div id="Prompt"></div>
    </div>
    <div id="Register_Box">
      <div id="Register_Content">
        <div id="Register_Content_Title">
          <div id="Register_Title_Img">
            <img src="../IMG/Rabbit_Black.png" alt="" />
          </div>
          <div id="Register_Title_Font">创建您的&nbsp;RaBBit&nbsp;ID</div>
        </div>
        <div id="Register_Content_Main">
          <div id="Register_Main_Font">
            只需一个&nbsp;RaBBit&nbsp;ID,&nbsp;您即可访问&nbsp;RaBBit&nbsp;所有内容。
            <br />
            已有&nbsp;RaBBit&nbsp;ID?&nbsp;<a onclick="Register_Page(false)"
              >&nbsp;登录&nbsp;&#8250;</a
            >
          </div>
          <div id="Register_Main_Name_Box">
            <div id="Register_Main_UserName">
              <input
                id="Register_UserName"
                onfocus="Register_Input(true,'UserName'),Input_Div(true,'UserName')"
                onblur="Register_Input_Num('UserName',0),Input_Div(false,'UserName')"
                type="text"
              />
              <p id="Input_Font_UserName">姓名</p>
            </div>
            <div id="Register_Main_PassWord">
              <input
                id="Register_PassWord"
                onfocus="Register_Input(true,'PassWord'),Input_Div(true,'PassWord')"
                onblur="Register_Input_Num('PassWord',0),Input_Div(false,'PassWord')"
                type="password"
              />
              <p id="Input_Font_PassWord">密码</p>
            </div>
          </div>
          <div id="Register_Main_ID_Title">编号或联系方式</div>
          <div id="Register_Main_ID">
            <input
              id="Register_ID"
              onfocus="Register_Input(true,'ID'),Input_Div(true,'ID')"
              onblur="Register_Input_Num('ID',12),Input_Div(false,'ID')"
              type="text"
            />
            <p id="Input_Font_ID">学号或管理员编号</p>
          </div>
          <div id="Register_Main_Number">
            <input
              id="Register_Number"
              onfocus="Register_Input(true,'Number'),Input_Div(true,'Number')"
              onblur="Register_Input_Num('Number',11),Input_Div(false,'Number')"
              type="text"
            />
            <p id="Input_Font_Number">联系方式</p>
          </div>
        </div>
        <div id="Register_Content_Button">
          <button id="Register_Cancel" onclick="Register_Page(false)">
            取消
          </button>
          <button id="Register_Submit" onclick="Register()">继续</button>
        </div>
      </div>
    </div>
    <div id="Img_Box">
      <div id="Img_Div">
        <!-- <canvas id="Img_Canvas" width="100px" height="100px" onmousewheel="CutImg()">
            </canvas>
            <button onclick="CutImg(false)">左移</button>
            <button onclick="CutImg(true)">右移</button> -->

        <!--  <span class="file"></span> -->

        <div id="Img_Title">修改您的头像</div>
        <div id="Img_Body">
          <div id="Img_Input">
            <input type="file" id="file" multiple="multiple" />
            <label for="file" id="Img_Label"> </label>
          </div>
          <div
            id="Img_Show"
            onclick="document.getElementById('Img_Label').click()"
          >
            <img id="Img_Up_Show" class="User_Img" alt="头像" />
          </div>
        </div>
        <div id="Img_Bottom">
          <input
            type="button"
            id="Img_Cancel_Button"
            onclick="Img_Div(false)"
            value="取消"
          />
          <input
            type="button"
            id="Img_OK_Button"
            onclick="Img_Update()"
            value="提交"
          />
        </div>
      </div>
    </div>
    <div id="All_Box">
      <div id="Home_Box">
        <div id="Home_Jpg"><img src="../IMG/Rabbit.png" alt="Logo" /></div>
        <div id="Home_Font">
          <h1>登录&nbsp;RaBBit</h1>
        </div>
        <div id="Home_MainBox">
          <div id="Home_UserName">
            <input
              id="UserName_Input"
              type="text"
              placeholder="User ID"
              onkeydown="if(event.keyCode==13){ChangeInput()}"
            />
            <div id="UserName_Enter">
              <img
                onclick="ChangeInput()"
                src="../IMG/Right_Test.png"
                alt="Enter"
              />
            </div>
          </div>
          <div id="Home_PassWord">
            <input
              id="PassWord_Input"
              type="password"
              onkeydown="if(event.keyCode==13){Login()}"
              placeholder="Passwords"
            />
            <div id="PassWord_Enter" type="submit" onclick="Login()">
              <img src="../IMG/Right_Test.png" alt="Enter" />
            </div>
          </div>
          <div id="Remember_Box">
            <input id="CheckBox" type="checkbox" />
            <label for="CheckBox">&nbsp;保持我的登录状态</label>
          </div>
          <div id="tooltip">
            <span id="tooltip_text"> </span>
          </div>
        </div>
        <div id="Home_Forget">
          <p>忘记了ID或密码&#63;&nbsp;&#8599;</p>
        </div>
      </div>

      <div id="Main_FlexBox">
        <div id="Icon_Box" onclick="Img_Div(true)">
          <div>
            <img
              src="../IMG/User_Null.png"
              alt="Logo"
              class="User_Img"
              id="User_Img"
            />
          </div>
        </div>
        <div id="Name_Box">
          <h1 id="Name_Font"></h1>
          <p>账户设置&gt;</p>
        </div>

        <div id="Content_Box">
          <!-- <div class="TEST"></div> -->
          <div id="Many_Div">
            <div onclick="Page('Course')">
              <div>
                <img src="../IMG/Schedule.png" />
              </div>
              <p>课程查看</p>
            </div>
            <div>
              <div>
                <img src="../IMG/News.png" />
              </div>
              <p>校务新闻</p>
            </div>
            <div>
              <div onclick="Page('Score')">
                <img src="../IMG/Score.png" />
              </div>
              <p>考试管理</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Duck.png" onclick="Page('Life')" />
              </div>
              <p>生活服务</p>
            </div>
            <div>
              <div>
                <img src="../IMG/GPS.png" />
              </div>
              <p>每日打卡</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Business.png" />
              </div>
              <p>个人信息</p>
            </div>
            <div>
              <div>
                <img src="../IMG/MindPiece.png" />
              </div>
              <p>社交聊天</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Report.png" />
              </div>
              <p>我的班级</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Book.png" />
              </div>
              <p>云图书</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Keynote.png" />
              </div>
              <p>教师管理</p>
            </div>
            <div>
              <div>
                <img src="../IMG/Admin.png" onclick="Page('Manage')" />
              </div>
              <p>后台管理</p>
            </div>
          </div>
          <!--  <div class="TEST"></div>
        </div> -->
        </div>
      </div>
    </div>
  </body>

  <script>
    window.onload = function () {
      document
        .getElementsByTagName("body")[0]
        .setAttribute("style", "opacity:" + "1");
      checkCookie();
      AutoPage();
    };
    let My_Url = "http://192.168.1.25:8081";
    var Admin_Boolean = () => {
      const Admin_Div = document.getElementById("Many_Div");
      const Num = Admin_Div.children.length - 1;
      console.log(Admin_Div.children[Num]);
      console.log(getCookie("Admin"));
      if (getCookie("Admin") == "学生") {
        Admin_Div.children[Num].style.display = "none";
      } else {
        Admin_Div.children[Num].style.display = "";
      }
    };

    var Exit = () => {
      document.cookie = "UserID=;Path=/;expires=0";
      const Admin_Div = document.getElementById("Many_Div");
      window.location.replace("/");
    };

    /* var canvas;
    var ctx, n, m, i, j, i, o;

    var imgUpload = new Image();
    imgUpload.src = "/img/" + getCookie("UserID") + ".jpeg";
    imgUpload.onload = function () {
        canvas = document.getElementById("Img_Canvas");
        ctx = canvas.getContext("2d");
        const hhh = 2467;
        const hhhh = 4250;
        console.log(hhh, hhhh);
        ctx.drawImage(imgUpload, 0, 0, hhh, hhhh);
        ctx.beginPath();
        ctx.arc(50, 50, 50, 0, 2 * Math.PI);
        ctx.stroke();
        n = hhh;
        m = hhhh;
        i = 0;
        j = 0;
        o = 2;
    } */

    CutImg = (state) => {
      if (state) {
        i += 2;
      } else if (!state) {
        i -= 2;
      }
      if (event.wheelDelta > 0) {
        console.log("图片缩小");
        /* imgUpload.width -= 1;
            imgUpload.height -= 1;
            ctx.arc(50, 50, n, 0, 2 * Math.PI); */
        n -= o;
        m -= o;
        i += o / 2;
        j += o / 2;
        /* ctx.stroke(); */
        console.log("width", imgUpload.width, "height", imgUpload.height);
      } else if (event.wheelDelta < 0) {
        n += o;
        m += o;
        i -= o / 2;
        j -= o / 2;
        console.log("图片放大");
      }
      ctx.drawImage(imgUpload, i, j, n, m);
    };

    window.onresize = function () {
      AutoPage();
    };

    function sleep(time) {
      return new Promise((resolve) => setTimeout(resolve, time));
    }

    function Page(page) {
      const PageName = page;
      document
        .getElementsByTagName("body")[0]
        .setAttribute("style", "filter:" + "blur(30px)");
      sleep(250).then(() => {
        if (PageName == "Manage") {
          window.location.href = "./Html/Manage/" + PageName + ".html";
        } else {
          window.location.href = "./Html/" + PageName + ".html";
        }
      });
    }

    var Img_Update = () => {
      const text = document.getElementById("file").files[0];
      const UserID = getCookie("UserID");
      var Img_Data = new FormData();
      Img_Data.append("UserImg", text);
      Img_Data.append("UserID", UserID);
      axios({
        method: "POST",
        url: My_Url + "/file/img",
        data: Img_Data,
      }).then((res) => {
        /* switch (res.data.err) {
                case -1:
                    message = "图片尺寸过大";
                    break;
                case -2:
                    message = "图片类型错误";
                    break;
                case -3:
                    message = "图片上传失败";
                    break;
                default:
            } */
        Prompt(res.data.message, 4500);

        setCookie("Img", res.data.path);
        Img_Div(false);
        location.reload();
      });
    };

    var ChangeInput = function () {
      const PassWord_Enter = document.getElementById("PassWord_Enter");
      document
        .getElementById("UserName_Enter")
        .setAttribute("style", "width:" + 0);
      document
        .getElementById("UserName_Input")
        .setAttribute("style", "margin-right:" + 1 + "rem");
      document
        .getElementById("Home_PassWord")
        .setAttribute("style", "display:" + "inherit");
      document
        .getElementById("PassWord_Input")
        .setAttribute("style", "visibility:" + "visible");
      PassWord_Enter.style.visibility = "visible";
      PassWord_Enter.style.margin = "0px";
      document
        .getElementById("Home_PassWord")
        .setAttribute("style", "opacity:" + "100%");
      document
        .getElementById("UserName_Input")
        .setAttribute("style", "filter:blur(0)");
      document
        .getElementById("PassWord_Input")
        .setAttribute("style", "filter:blur(0)");
    };

    var Register_Page = function (Show) {
      const Show_Boolean = Show;
      const Title_Box = document.getElementById("Title_Box");
      const All_Box = document.getElementById("All_Box");
      const Register_Box = document.getElementById("Register_Box");
      if (Show_Boolean) {
        Title_Box.style.filter = "brightness(60%)";
        All_Box.style.filter = "brightness(60%)";
        Register_Box.style.visibility = "visible";
        Register_Box.style.opacity = "1";
      } else {
        document.getElementById("Register_UserName").value = null;
        document.getElementById("Register_PassWord").value = null;
        document.getElementById("Register_ID").value = null;
        document.getElementById("Register_Number").value = null;
        Register_Input_Num("UserName", 0);
        Register_Input_Num("PassWord", 0);
        Register_Input_Num("ID", 0);
        Register_Input_Num("Number", 0);
        Title_Box.style.filter = "brightness(100%)";
        All_Box.style.filter = "brightness(100%)";
        Register_Box.style.visibility = "hidden";
        Register_Box.style.opacity = "0";
      }
    };

    var Img_Div = (Show) => {
      const Show_Boolean = Show;
      const Title_Box = document.getElementById("Title_Box");
      const All_Box = document.getElementById("All_Box");
      const Img_Box = document.getElementById("Img_Box");
      if (Show_Boolean) {
        Title_Box.style.filter = "brightness(60%)";
        All_Box.style.filter = "brightness(60%)";
        Img_Box.style.visibility = "visible";
        Img_Box.style.opacity = "1";
        OnLoad_Img();
      } else {
        Title_Box.style.filter = "brightness(100%)";
        All_Box.style.filter = "brightness(100%)";
        Img_Box.style.visibility = "hidden";
        Img_Box.style.opacity = "0";
      }
    };

    var Register_Input_Num = function (Element_Name, Max_Num) {
      const Element = Element_Name;
      const Max = Max_Num;
      const Element_Input = document.getElementById("Register_" + Element);
      const Element_Font = document.getElementById("Input_Font_" + Element);
      const Element_Length = Element_Input.value.length;
      Register_Input(Element_Length, Element);
      if (Element_Length == 0) {
        const Message = Element_Font.innerText + "不允许为空!";
        Prompt(Message, 4500);
      } else if (Element_Length !== Max && Max !== 0) {
        const Message = Element_Font.innerText + "为" + Max + "位!";
        Prompt(Message, 4500);
      }
    };

    var Register_Input = function (Show, Element_Name) {
      const Element = Element_Name;
      const Show_State = Show;
      const Input_Font = document.getElementById("Input_Font_" + Element);
      if (Show_State) {
        Input_Font.style.fontSize = "0.5rem";
        Input_Font.style.margin = "0 0 0 1rem";
      } else {
        Input_Font.style.fontSize = "1.2rem";
        Input_Font.style.margin = "1rem 0 0 1rem";
      }
    };

    var Input_Div = function (Show, Element_Name) {
      const Element = Element_Name;
      const Show_State = Show;
      const Input_Div = document.getElementById("Register_Main_" + Element);
      if (Show_State) {
        Input_Div.style.borderColor = "#0070C9";
        Input_Div.style.boxShadow = "0 0 0 3px rgb(131 192 253 / 50%)";
      } else {
        Input_Div.style.borderColor = "#d6d6d6";
        Input_Div.style.boxShadow = "none";
      }
    };

    var Register = function () {
      const UserName_Input = document.getElementById("Register_UserName");
      const PassWord_Input = document.getElementById("Register_PassWord");
      const ID_Input = document.getElementById("Register_ID");
      const Number_Input = document.getElementById("Register_Number");

      const UserName = UserName_Input.value;
      const PassWord = PassWord_Input.value;
      const ID = ID_Input.value;
      const Number = Number_Input.value;
      if (
        UserName.length != 0 &&
        PassWord.length != 0 &&
        ID.length == 12 &&
        Number.length == 11
      ) {
        console.log(UserName, PassWord, ID, Number);
        axios({
          method: "POST",
          url: My_Url + "/home/register",
          data: {
            UserName: UserName,
            PassWord: PassWord,
            ID: ID,
            Number: Number,
          },
        }).then(function (res) {
          console.log(res);
          if (res.data.message == "Success") {
            Register_Page(false);
            Prompt(
              "创建 RaBBit ID 成功!\n您的 RaBBit ID 为学号或管理员编号\n现在您可以使用 RaBBit ID 进行登录",
              4500
            );
          } else {
            Prompt(res.data.message, 4500);
          }
        });
      } else {
        Prompt("请按照要求进行注册填写!", 4500);
      }
    };

    var Login = async function () {
      const Login_Wrong = function () {
        const TipText = document.getElementById("tooltip_text");
        const ToolTip = document.getElementById("tooltip");
        ToolTip.style.visibility = "visible";
        ToolTip.style.opacity = 1;
        TipText.innerText = "RaBBit ID或密码不正确";
        sleep(5000).then(() => {
          ToolTip.style.opacity = 0;
          ToolTip.style.visibility = "hidden";
        });
      };
      const GET_ID = document.getElementById("UserName_Input");
      const GET_Password = document.getElementById("PassWord_Input");
      var ID = GET_ID.value;
      var PassWord = GET_Password.value;
      axios({
        method: "post",
        url: My_Url + "/home/login",
        data: {
          ID: ID,
          PassWord: PassWord,
        },
      }).then(function (res) {
        if (res.data.message == "Null") {
          console.log("用户不存在");
          Login_Wrong();
        } else if (res.data.message == "Wrong") {
          console.log("密码错误");
          Login_Wrong();
        } else if (res.data.message == "Success") {
          console.log(res.data.user.img);
          let User_Img = document.getElementById("User_Img");
          User_Img.src = res.data.user.img;
          console.log(res.data.user.img);
          setCookie("Img", res.data.user.img);
          setCookie("Admin", res.data.user.admin);
          setCookie("Number", res.data.user.number);
          Login_Success(ID, res.data.user.username);
        }
      });
    };

    var Login_Success = function (id, username) {
      Admin_Boolean();
      const Day = new Date();
      const Hour = Day.getHours();
      console.log(Hour);
      let Hour_font;
      switch (true) {
        case Hour < 6 || Hour >= 21:
          Hour_font = ",晚上好!";
          break;
        case Hour >= 6 && Hour < 12:
          Hour_font = ",上午好!";
          break;
        case Hour >= 12 && Hour < 21:
          Hour_font = ",下午好!";
          break;
      }
      const Check = document.getElementById("CheckBox");
      const TipText = document.getElementById("tooltip_text");
      const ToolTip = document.getElementById("tooltip");
      const Name_Font = document.getElementById("Name_Font");
      /* const */
      if (Check.checked == true) {
        setCookie("UserID", id, 30);
        setCookie("UserName", username, 30);
      } else {
        setCookie("UserID", id);
        setCookie("UserName", username);
      }
      ToolTip.style.visibility = "hidden";
      ToolTip.style.opacity = 0;
      TipText.innerText = "";
      document
        .getElementById("Home_Box")
        .setAttribute("style", "opacity:" + "0%");
      Name_Font.innerText = username + Hour_font;

      sleep(500).then(() => {
        document
          .getElementById("Home_Box", "UserName_Input", "PassWord_Input")
          .setAttribute("style", "display:" + "none");
        const Main_FlexBox = document.getElementById("Main_FlexBox");
        Main_FlexBox.style.opacity = 1;
        Main_FlexBox.style.filter = "none";
        Main_FlexBox.style.pointerEvents = "initial";
      });
    };

    var Prompt = function (Content, Time) {
      const Message = Content;
      const Prompt = document.getElementById("Prompt");
      const Prompt_Box = document.getElementById("Prompt_Box");
      Prompt_Box.style.visibility = "visible";
      Prompt_Box.style.opacity = "1";
      Prompt.innerText = Message;
      sleep(Time).then(() => {
        Prompt_Box.style.opacity = "0";
        Prompt_Box.style.visibility = "hidden";
      });
    };

    window.onpopstate = function (event) {
      console.log(event.state);
    };

    function setCookie(cname, id, day) {
      var d = new Date();
      d.setTime(d.getTime() + day /* * 24 * 60 * 60  */ * 1000);
      var expires = "expires=" + d.toGMTString();
      document.cookie = cname + "=" + id + "; " + expires;
    }

    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(";");
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i].trim();
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    function checkCookie() {
      const UserID = getCookie("UserID");
      const UserName = getCookie("UserName");
      const Img_Src = getCookie("Img");
      console.log(UserID);
      if (UserID !== "") {
        OnLoad_Img();
        Login_Success(UserID, UserName);
      }
    }

    var OnLoad_Img = () => {
      Img_Src = getCookie("Img");
      console.log(Img_Src);
      const User_Img = document.getElementsByClassName("User_Img");
      for (let i = 0; i < User_Img.length; i++) {
        User_Img[i].src = Img_Src;
      }
    };

    var AutoPage = function () {
      var Self = this;
      if (screen.width < 768) {
        Self.width = 750;
        Self.fontSize = 23;
        const Register_Box = document.getElementById("Register_Content");
        Self.widthProportion = function () {
          var p =
            ((document.body && document.body.clientWidth) ||
              document.getElementsByTagName("html")[0].offsetWidth) /
            Self.width;
          return p;
        };
        Self.changePage = function () {
          document
            .getElementsByTagName("html")[0]
            .setAttribute(
              "style",
              "font-size:" + Self.widthProportion() * Self.fontSize + "px"
            );
          document
            .getElementById("Home_Font")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("Remember_Box")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("tooltip")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("UserName_Input")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("PassWord_Input")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("Home_Forget")
            .setAttribute("style", "filter:blur(0)");
          document
            .getElementById("Prompt_Box")
            .setAttribute("style", "align-items:center");
          document
            .getElementById("Prompt")
            .setAttribute("style", "text-align:center");
          Register_Box.style.marginTop = "10%";
          Register_Box.style.width = "100%";
        };
        Self.changePage();
        window.addEventListener(
          "resize",
          function () {
            Self.changePage();
          },
          false
        );
      }
    };

    file.addEventListener("change", function () {
      let file = this.files[0];
      if (!/image\/\w+/.test(file.type)) {
        Prompt("请以图片形式上传", 4500);
        return false;
      }
      document.getElementById("Img_Up_Show").src = URL.createObjectURL(file);
    });
  </script>
</html>
